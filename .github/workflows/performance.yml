name: Performance Monitoring

on:
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: 'performance-${{ github.ref }}'
  cancel-in-progress: true

env:
  # Define audited pages centrally - easier to maintain
  AUDIT_PATHS: '/ /blog/ /research/ /projects/ /notes/'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      base-url: ${{ steps.site.outputs.base-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve deployed site URL
        id: site
        run: |
          if [ -f public/CNAME ]; then
            domain=$(cat public/CNAME | tr -d '\n' | tr -d '\r')
            base_url="https://$domain"
          else
            owner="${{ github.repository_owner }}"
            repo="${{ github.event.repository.name }}"
            base_url="https://$owner.github.io/$repo"
          fi
          echo "base-url=$base_url" >> $GITHUB_OUTPUT
          echo "Site URL: $base_url"

      - name: Build Lighthouse URL list
        id: urls
        run: |
          base_url="${{ steps.site.outputs.base-url }}"
          urls=""
          for path in $AUDIT_PATHS; do
            urls="${urls}${base_url}${path}"$'\n'
          done
          # Write to file for the action (handles newlines better)
          echo "$urls" > /tmp/lighthouse-urls.txt
          echo "URLs to audit:"
          cat /tmp/lighthouse-urls.txt

      - name: Run Lighthouse CI Audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.site.outputs.base-url }}/
            ${{ steps.site.outputs.base-url }}/blog/
            ${{ steps.site.outputs.base-url }}/research/
            ${{ steps.site.outputs.base-url }}/projects/
            ${{ steps.site.outputs.base-url }}/notes/
          configPath: .lighthouserc.cjs
          budgetPath: .lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Performance Summary
        if: always()
        run: |
          echo "## Lighthouse Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** ${{ steps.site.outputs.base-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f .lighthouseci/manifest.json ]; then
            echo "| Page | Perf | A11y | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|------|----------------|-----|" >> $GITHUB_STEP_SUMMARY

            jq -r '.[] | "\(.url)|\(.summary.performance)|\(.summary.accessibility)|\(.summary["best-practices"])|\(.summary.seo)"' .lighthouseci/manifest.json | while IFS='|' read -r url perf a11y bp seo; do
              path=$(echo "$url" | sed "s|${{ steps.site.outputs.base-url }}||")
              [ -z "$path" ] && path="/"
              perf_pct=$(awk "BEGIN {printf \"%.0f\", $perf * 100}")
              a11y_pct=$(awk "BEGIN {printf \"%.0f\", $a11y * 100}")
              bp_pct=$(awk "BEGIN {printf \"%.0f\", $bp * 100}")
              seo_pct=$(awk "BEGIN {printf \"%.0f\", $seo * 100}")
              echo "| \`$path\` | $perf_pct | $a11y_pct | $bp_pct | $seo_pct |" >> $GITHUB_STEP_SUMMARY
            done

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Targets: Performance >= 90, others >= 80" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Lighthouse results available" >> $GITHUB_STEP_SUMMARY
          fi

  accessibility:
    name: Deep Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lighthouse
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v2
        id: setup-chrome
        with:
          chrome-version: stable

      - name: Test accessibility with Pa11y CI
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          echo "Testing pages with Pa11y CI..."
          echo "Using Chrome at: $PUPPETEER_EXECUTABLE_PATH"
          npx -y pa11y-ci --config .pa11yci.json 2>&1 | tee /tmp/pa11y-output.txt || true
          
          # Count results for summary
          passed=$(grep -c "✔" /tmp/pa11y-output.txt || echo "0")
          failed=$(grep -c "✖" /tmp/pa11y-output.txt || echo "0")
          echo "PASSED=$passed" >> $GITHUB_ENV
          echo "FAILED=$failed" >> $GITHUB_ENV
          
          if [ "$failed" -gt 0 ]; then
            echo "::warning::$failed page(s) have accessibility issues"
          fi

      - name: Accessibility Summary
        if: always()
        run: |
          echo "## Accessibility Audit (Pa11y CI)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/pa11y-output.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No results available"
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Standard: WCAG 2.1 AA" >> $GITHUB_STEP_SUMMARY

