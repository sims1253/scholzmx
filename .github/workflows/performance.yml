name: Performance Monitoring

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Cancel old runs when new ones are triggered
concurrency:
  group: 'performance-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 'latest'

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build site
        run: bun run build

      - name: Serve site
        run: |
          bun run preview &
          sleep 5
          # Verify site is running
          curl -f http://localhost:4321 || exit 1

      - name: Run Lighthouse CI Audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:4321/
            http://localhost:4321/blog/
            http://localhost:4321/research/
            http://localhost:4321/projects/
            http://localhost:4321/notes/
          configPath: .lighthouserc.cjs
          budgetPath: .lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
        timeout-minutes: 15

      - name: Performance Summary
        if: always()
        run: |
          echo "## ðŸš€ Performance Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Key Metrics Monitored" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Score**: Core web vitals and loading metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility**: WCAG compliance and usability" >> $GITHUB_STEP_SUMMARY
          echo "- **Best Practices**: Modern web development standards" >> $GITHUB_STEP_SUMMARY
          echo "- **SEO**: Search engine optimization metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Budget**: Resource size limits to prevent bloat" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Pages Audited" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage" >> $GITHUB_STEP_SUMMARY
          echo "- Blog listing" >> $GITHUB_STEP_SUMMARY
          echo "- Research page" >> $GITHUB_STEP_SUMMARY
          echo "- Projects page" >> $GITHUB_STEP_SUMMARY
          echo "- Notes section" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Performance Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Check the detailed Lighthouse reports in the action artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Performance budgets will fail the build if exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- Aim for Performance Score â‰¥90 and all other categories â‰¥80" >> $GITHUB_STEP_SUMMARY

  # Separate accessibility validation with PA11y (from your existing setup)
  accessibility:
    name: Deep Accessibility Audit
    runs-on: ubuntu-latest
    needs: lighthouse
    if: github.event_name != 'pull_request' || github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 'latest'

      - name: Cache bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            ~/.cache/bun
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock*') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build and test accessibility
        run: |
          bun run build
          bun run preview &
          sleep 5
          # Run accessibility audit with PA11y for detailed a11y testing
          bun run a11y || echo "Some accessibility issues found - check output"
        timeout-minutes: 10

      - name: Accessibility Summary
        if: always()
        run: |
          echo "## â™¿ Accessibility Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Accessibility Standards" >> $GITHUB_STEP_SUMMARY
          echo "- **WCAG 2.1 AA Compliance**: Industry standard accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- **PA11y Testing**: Automated accessibility validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Lighthouse a11y**: Additional accessibility scoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ What's Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard navigation support" >> $GITHUB_STEP_SUMMARY
          echo "- Screen reader compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- Color contrast ratios" >> $GITHUB_STEP_SUMMARY
          echo "- Image alt text coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Form label associations" >> $GITHUB_STEP_SUMMARY
          echo "- Heading structure hierarchy" >> $GITHUB_STEP_SUMMARY
