name: Performance Monitoring

on:
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: 'performance-${{ github.ref }}'
  cancel-in-progress: true

env:
  # Define audited pages centrally - easier to maintain
  AUDIT_PATHS: '/ /blog/ /research/ /projects/ /notes/'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      base-url: ${{ steps.site.outputs.base-url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve deployed site URL
        id: site
        run: |
          if [ -f public/CNAME ]; then
            domain=$(cat public/CNAME | tr -d '\n' | tr -d '\r')
            base_url="https://$domain"
          else
            owner="${{ github.repository_owner }}"
            repo="${{ github.event.repository.name }}"
            base_url="https://$owner.github.io/$repo"
          fi
          echo "base-url=$base_url" >> $GITHUB_OUTPUT
          echo "Site URL: $base_url"

      - name: Build Lighthouse URL list
        id: urls
        run: |
          base_url="${{ steps.site.outputs.base-url }}"
          urls=""
          for path in $AUDIT_PATHS; do
            urls="${urls}${base_url}${path}"$'\n'
          done
          # Write to file for the action (handles newlines better)
          echo "$urls" > /tmp/lighthouse-urls.txt
          echo "URLs to audit:"
          cat /tmp/lighthouse-urls.txt

      - name: Run Lighthouse CI Audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.site.outputs.base-url }}/
            ${{ steps.site.outputs.base-url }}/blog/
            ${{ steps.site.outputs.base-url }}/research/
            ${{ steps.site.outputs.base-url }}/projects/
            ${{ steps.site.outputs.base-url }}/notes/
          configPath: .lighthouserc.cjs
          budgetPath: .lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Performance Summary
        if: always()
        run: |
          echo "## ðŸš€ Performance Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** ${{ steps.site.outputs.base-url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Metrics Monitored" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Score (Core Web Vitals)" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility (WCAG compliance)" >> $GITHUB_STEP_SUMMARY
          echo "- Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "- SEO" >> $GITHUB_STEP_SUMMARY
          echo "- Performance Budget" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Pages Audited" >> $GITHUB_STEP_SUMMARY
          for path in $AUDIT_PATHS; do
            echo "- \`$path\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Check detailed reports in the action artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Target: Performance â‰¥90, other categories â‰¥80" >> $GITHUB_STEP_SUMMARY

  accessibility:
    name: Deep Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lighthouse
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test accessibility with Pa11y
        run: |
          base_url="${{ needs.lighthouse.outputs.base-url }}"
          echo "Testing: $base_url"

          # Run Pa11y and capture exit code
          set +e
          npx -y pa11y "$base_url" --reporter cli
          exit_code=$?
          set -e

          if [ $exit_code -ne 0 ]; then
            echo "::warning::Accessibility issues detected (exit code: $exit_code)"
          else
            echo "âœ“ No accessibility issues found"
          fi

      - name: Accessibility Summary
        if: always()
        run: |
          echo "## â™¿ Accessibility Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Standards" >> $GITHUB_STEP_SUMMARY
          echo "- WCAG 2.1 AA Compliance" >> $GITHUB_STEP_SUMMARY
          echo "- PA11y automated validation" >> $GITHUB_STEP_SUMMARY
          echo "- Lighthouse accessibility scoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard navigation" >> $GITHUB_STEP_SUMMARY
          echo "- Screen reader compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- Color contrast" >> $GITHUB_STEP_SUMMARY
          echo "- Image alt text" >> $GITHUB_STEP_SUMMARY
          echo "- Form labels" >> $GITHUB_STEP_SUMMARY
          echo "- Heading hierarchy" >> $GITHUB_STEP_SUMMARY
