name: Performance Monitoring

on:
  workflow_run:
    workflows: ['Deploy to GitHub Pages']
    types: [completed]
    branches: [main, master]
  workflow_dispatch:

# Cancel old runs when new ones are triggered
concurrency:
  group: 'performance-${{ github.ref }}'
  cancel-in-progress: true

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout code (for LH config)
        uses: actions/checkout@v4

      - name: Resolve deployed site URL
        id: site
        run: |
          if [ -f public/CNAME ]; then
            domain=$(cat public/CNAME | tr -d '\n' | tr -d '\r')
            echo "Using custom domain: $domain"
            echo "base-url=https://$domain" >> $GITHUB_OUTPUT
          else
            # Fall back to GitHub Pages project URL
            owner="${{ github.repository_owner }}"
            repo="${{ github.event.repository.name }}"
            echo "base-url=https://$owner.github.io/$repo" >> $GITHUB_OUTPUT
          fi

      - name: Run Lighthouse CI Audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ steps.site.outputs.base-url }}/
            ${{ steps.site.outputs.base-url }}/blog/
            ${{ steps.site.outputs.base-url }}/research/
            ${{ steps.site.outputs.base-url }}/projects/
            ${{ steps.site.outputs.base-url }}/notes/
          configPath: .lighthouserc.cjs
          budgetPath: .lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
        timeout-minutes: 15

      - name: Performance Summary
        if: always()
        run: |
          echo "## ðŸš€ Performance Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Key Metrics Monitored" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Score**: Core web vitals and loading metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Accessibility**: WCAG compliance and usability" >> $GITHUB_STEP_SUMMARY
          echo "- **Best Practices**: Modern web development standards" >> $GITHUB_STEP_SUMMARY
          echo "- **SEO**: Search engine optimization metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Budget**: Resource size limits to prevent bloat" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ˆ Pages Audited" >> $GITHUB_STEP_SUMMARY
          echo "- Homepage" >> $GITHUB_STEP_SUMMARY
          echo "- Blog listing" >> $GITHUB_STEP_SUMMARY
          echo "- Research page" >> $GITHUB_STEP_SUMMARY
          echo "- Projects page" >> $GITHUB_STEP_SUMMARY
          echo "- Notes section" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Performance Tips" >> $GITHUB_STEP_SUMMARY
          echo "- Check the detailed Lighthouse reports in the action artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Performance budgets will fail the build if exceeded" >> $GITHUB_STEP_SUMMARY
          echo "- Aim for Performance Score â‰¥90 and all other categories â‰¥80" >> $GITHUB_STEP_SUMMARY

  # Separate accessibility validation with PA11y (from your existing setup)
  accessibility:
    name: Deep Accessibility Audit
    runs-on: ubuntu-latest
    needs: lighthouse
    if: github.event_name != 'pull_request' || github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve deployed site URL
        id: site
        run: |
          if [ -f public/CNAME ]; then
            domain=$(cat public/CNAME | tr -d '\n' | tr -d '\r')
            echo "base-url=https://$domain" >> $GITHUB_OUTPUT
          else
            owner="${{ github.repository_owner }}"
            repo="${{ github.event.repository.name }}"
            echo "base-url=https://$owner.github.io/$repo" >> $GITHUB_OUTPUT
          fi

      - name: Test accessibility against live site
        run: |
          echo "Testing: ${{ steps.site.outputs.base-url }}"
          npx -y pa11y ${{ steps.site.outputs.base-url }} || echo "Some accessibility issues found - check output"
        timeout-minutes: 10

      - name: Accessibility Summary
        if: always()
        run: |
          echo "## â™¿ Accessibility Audit Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Accessibility Standards" >> $GITHUB_STEP_SUMMARY
          echo "- **WCAG 2.1 AA Compliance**: Industry standard accessibility" >> $GITHUB_STEP_SUMMARY
          echo "- **PA11y Testing**: Automated accessibility validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Lighthouse a11y**: Additional accessibility scoring" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ What's Tested" >> $GITHUB_STEP_SUMMARY
          echo "- Keyboard navigation support" >> $GITHUB_STEP_SUMMARY
          echo "- Screen reader compatibility" >> $GITHUB_STEP_SUMMARY
          echo "- Color contrast ratios" >> $GITHUB_STEP_SUMMARY
          echo "- Image alt text coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Form label associations" >> $GITHUB_STEP_SUMMARY
          echo "- Heading structure hierarchy" >> $GITHUB_STEP_SUMMARY
